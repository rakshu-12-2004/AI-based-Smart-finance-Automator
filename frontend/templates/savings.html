{% extends "base.html" %}

{% block title %}Savings Recommendations - Smart Finance Automator{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Savings Recommendations</h1>
                    <p class="text-white">Personalized insights to optimize your spending and increase savings</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshRecommendations()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#savingsGoalModal">
                        <i class="fas fa-plus me-2"></i>Set Savings Goal
                    </button>
                </div>
            </div>
            
            <!-- Savings Overview Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-6 col-xl-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fs-6 fw-semibold">Potential Savings</div>
                                    <div class="fs-3 fw-bold">₹2,500</div>
                                    <div class="fs-7 opacity-75">Per month</div>
                                </div>
                                <div class="text-end">
                                    <i class="fas fa-piggy-bank fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fs-6 fw-semibold">Active Recommendations</div>
                                    <div class="fs-3 fw-bold">{{ recommendations|length }}</div>
                                    <div class="fs-7 opacity-75">Available tips</div>
                                </div>
                                <div class="text-end">
                                    <i class="fas fa-lightbulb fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3">
                    <div class="card bg-warning text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fs-6 fw-semibold">Easy Wins</div>
                                    <div class="fs-3 fw-bold">5</div>
                                    <div class="fs-7 opacity-75">Quick actions</div>
                                </div>
                                <div class="text-end">
                                    <i class="fas fa-trophy fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3">
                    <div class="card bg-primary text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fs-6 fw-semibold">Savings Rate</div>
                                    <div class="fs-3 fw-bold">15%</div>
                                    <div class="fs-7 opacity-75">Of income</div>
                                </div>
                                <div class="text-end">
                                    <i class="fas fa-percentage fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recommendations Grid -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-magic me-2"></i>Personalized Recommendations
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if recommendations %}
                                <div class="recommendations-list">
                                    {% for recommendation in recommendations %}
                                    <div class="recommendation-item mb-4 p-4 border rounded">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="recommendation-icon me-3">
                                                    {% if recommendation.type == 'subscription_optimization' %}
                                                        <i class="fas fa-tv fa-2x text-white"></i>
                                                    {% elif recommendation.type == 'budget_limit' %}
                                                        <i class="fas fa-wallet fa-2x text-white"></i>
                                                    {% elif recommendation.type == 'frequency_reduction' %}
                                                        <i class="fas fa-chart-line fa-2x text-white"></i>
                                                    {% else %}
                                                        <i class="fas fa-lightbulb fa-2x text-white"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">{{ recommendation.title }}</h6>
                                                    <p class="text-white mb-0">{{ recommendation.description }}</p>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="savings-amount fw-bold text-white">
                                                    +₹{{ "%.0f"|format(recommendation.potential_monthly_savings) }}/month
                                                </div>
                                                <div class="difficulty-badge">
                                                    {% set difficulty_class = 'success' if recommendation.difficulty == 'easy' else ('warning' if recommendation.difficulty == 'medium' else 'danger') %}
                                                    <span class="badge bg-{{ difficulty_class }}">{{ recommendation.difficulty.title() }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if recommendation.action_items %}
                                        <div class="action-items">
                                            <h6 class="small fw-bold text-white mb-2">ACTION STEPS:</h6>
                                            <ul class="list-unstyled mb-0">
                                                {% for action in recommendation.action_items %}
                                                <li class="d-flex align-items-start mb-1">
                                                    <i class="fas fa-check-circle text-white me-2 mt-1"></i>
                                                    <span class="small">{{ action }}</span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                            <div class="small text-white">
                                                Category: <span class="text-capitalize">{{ recommendation.category }}</span>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-success" onclick="markAsImplemented({{ loop.index0 }})">
                                                    <i class="fas fa-check me-1"></i>Done
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="dismissRecommendation({{ loop.index0 }})">
                                                    <i class="fas fa-times me-1"></i>Dismiss
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-line fa-3x text-white mb-3"></i>
                                    <h5 class="text-white">Generating Recommendations</h5>
                                    <p class="text-white">We need more transaction data to provide personalized savings recommendations.</p>
                                    <a href="{{ url_for('upload_data') }}" class="btn btn-primary">
                                        <i class="fas fa-upload me-2"></i>Upload Transaction Data
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Savings Progress -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-target me-2"></i>Savings Progress
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 65%">
                                    65%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-sm">
                                <span>₹13,000 saved</span>
                                <span>₹20,000 goal</span>
                            </div>
                            <p class="text-white small mt-2">You're doing great! Keep up the momentum.</p>
                        </div>
                    </div>
                    
                    <!-- Quick Tips -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-rocket me-2"></i>Quick Wins
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="quick-tips">
                                <div class="tip-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-mobile-alt text-white me-3"></i>
                                        <div>
                                            <div class="fw-bold small">Review Subscriptions</div>
                                            <div class="text-white small">Cancel unused services</div>
                                        </div>
                                        <div class="ms-auto">
                                            <span class="badge bg-success text-white">+₹800</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tip-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-utensils text-white me-3"></i>
                                        <div>
                                            <div class="fw-bold small">Cook More at Home</div>
                                            <div class="text-white small">Reduce dining out</div>
                                        </div>
                                        <div class="ms-auto">
                                            <span class="badge bg-success text-white">+₹1,200</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tip-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-shopping-cart text-white me-3"></i>
                                        <div>
                                            <div class="fw-bold small">Use Coupons</div>
                                            <div class="text-white small">Save on groceries</div>
                                        </div>
                                        <div class="ms-auto">
                                            <span class="badge bg-success text-white">+₹500</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spending Insights -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Spending Insights
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="spendingInsightsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Savings Goal Modal -->
<div class="modal fade" id="savingsGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Savings Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="savingsGoalForm">
                    <div class="mb-3">
                        <label for="goalTitle" class="form-label">Goal Title</label>
                        <input type="text" class="form-control" id="goalTitle" placeholder="e.g., Emergency Fund, Vacation">
                    </div>
                    
                    <div class="mb-3">
                        <label for="goalAmount" class="form-label">Target Amount (₹)</label>
                        <input type="number" class="form-control" id="goalAmount" placeholder="50000">
                    </div>
                    
                    <div class="mb-3">
                        <label for="goalDate" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="goalDate">
                    </div>
                    
                    <div class="mb-3">
                        <label for="goalDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="goalDescription" rows="3" placeholder="Why is this goal important to you?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSavingsGoal()">Save Goal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize spending insights chart
function initSpendingInsightsChart() {
    const ctx = document.getElementById('spendingInsightsChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Dining', 'Shopping', 'Groceries', 'Entertainment', 'Other'],
            datasets: [{
                data: [30, 25, 20, 15, 10],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

function markAsImplemented(index) {
    // Here you would typically send a request to mark the recommendation as implemented
    showAlert('Recommendation marked as implemented! Great job!', 'success');
    
    // Optionally hide the recommendation
    const recommendationItems = document.querySelectorAll('.recommendation-item');
    if (recommendationItems[index]) {
        recommendationItems[index].style.opacity = '0.5';
        recommendationItems[index].querySelector('.btn-group').innerHTML = 
            '<span class="badge bg-success text-white"><i class="fas fa-check me-1"></i>Implemented</span>';
    }
}

function dismissRecommendation(index) {
    const recommendationItems = document.querySelectorAll('.recommendation-item');
    if (recommendationItems[index]) {
        recommendationItems[index].style.display = 'none';
        showAlert('Recommendation dismissed', 'info');
    }
}

function refreshRecommendations() {
    location.reload();
}

function saveSavingsGoal() {
    const title = document.getElementById('goalTitle').value;
    const amount = document.getElementById('goalAmount').value;
    const date = document.getElementById('goalDate').value;
    const description = document.getElementById('goalDescription').value;
    
    if (!title || !amount) {
        showAlert('Please fill in the required fields', 'warning');
        return;
    }
    
    // Here you would typically save to the backend
    showAlert('Savings goal created successfully!', 'success');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('savingsGoalModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('savingsGoalForm').reset();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid .row .col-12');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    initSpendingInsightsChart();
});
</script>

<style>
.recommendation-item {
    transition: all 0.3s ease;
}

.recommendation-item:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.recommendation-icon {
    flex-shrink: 0;
}

.savings-amount {
    font-size: 1.1rem;
}

.action-items {
    background: rgba(0, 0, 0, 0.02);
    padding: 1rem;
    border-radius: 0.375rem;
    margin-top: 1rem;
}

.tip-item {
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: background-color 0.2s;
}

.tip-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
}
</style>
{% endblock %}
